<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoLearners Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .animated-bg {
            background: linear-gradient(270deg, #a8edea, #fed6e3, #84fab0, #8fd3f4);
            background-size: 800% 800%;
            animation: gradientAnimation 18s ease infinite;
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .tab-active {
            border-bottom-color: #34D399; /* emerald-400 */
            color: #10B981; /* emerald-500 */
            font-weight: 600;
        }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="text-gray-800">

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="animated-bg min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-4xl glassmorphism rounded-2xl shadow-2xl overflow-hidden" style="animation: fadeIn 1s ease-in-out;">
            <div class="grid md:grid-cols-2">
                <div class="p-8 md:p-12 bg-emerald-500 text-white flex flex-col justify-center items-center text-center">
                    <div class="mb-6">
                        <div class="w-24 h-24 bg-white/30 rounded-full flex items-center justify-center mx-auto shadow-lg">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v1.586M12 17.747v1.586M16.747 12h1.586M5.667 12h1.586M14.333 7.667l1.12 1.12M7.667 14.333l1.12 1.12M14.333 14.333l1.12-1.12M7.667 7.667l1.12-1.12" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a6 6 0 100-12 6 6 0 000 12z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 14a2 2 0 100-4 2 2 0 000 4z" />
                            </svg>
                        </div>
                    </div>
                    <h1 class="text-3xl font-bold mb-2">Welcome to EcoLearners</h1>
                    <p class="text-emerald-100">Your journey towards a sustainable future starts here.</p>
                </div>
                <div class="p-8 md:p-12">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">Login to Your Account</h2>
                    <form id="loginForm">
                        <div class="mb-4">
                            <label for="role" class="block text-gray-600 mb-2">I am a</label>
                            <select id="role" class="w-full px-4 py-2 border rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                <option value="student">Student</option>
                                <option value="teacher">Teacher</option>
                            </select>
                        </div>
                        <div class="mb-4 relative">
                            <label for="email" class="block text-gray-600 mb-2">Email Address</label>
                             <span class="absolute inset-y-0 left-0 flex items-center pl-3 pt-8">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                            </span>
                            <input type="email" id="email" class="w-full pl-10 pr-4 py-2 border rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="you@example.com" required>
                        </div>
                        <div class="mb-6 relative">
                            <label for="password" class="block text-gray-600 mb-2">Password</label>
                             <span class="absolute inset-y-0 left-0 flex items-center pl-3 pt-8">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                            </span>
                            <input type="password" id="password" class="w-full pl-10 pr-4 py-2 border rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                        </div>
                        <button type="submit" class="w-full bg-emerald-500 text-white py-2 rounded-lg font-semibold hover:bg-emerald-600 transition-colors duration-300 transform hover:scale-105">Login</button>
                    </form>
                    <p id="loginError" class="text-red-500 text-sm mt-4 text-center"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION (STUDENT/TEACHER) -->
    <div id="appContainer" class="hidden bg-gray-50 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-50">
            <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center text-white font-bold text-lg">E</div>
                    <h1 class="text-xl font-bold text-gray-700">EcoLearners Platform</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="font-semibold text-gray-800" id="userName"></p>
                        <p class="text-sm text-gray-500 capitalize" id="userRole"></p>
                    </div>
                    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">Logout</button>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-6">
            <!-- STUDENT VIEW -->
            <div id="studentView" class="hidden">
                <div class="mb-6 border-b border-gray-200">
                    <nav class="flex space-x-8" id="studentTabs"></nav>
                </div>
                <div id="studentPanes"></div>
            </div>

            <!-- TEACHER VIEW -->
            <div id="teacherView" class="hidden">
                 <div class="mb-6 border-b border-gray-200">
                    <nav class="flex space-x-8" id="teacherTabs"></nav>
                </div>
                <div id="teacherPanes"></div>
            </div>
        </main>
    </div>

    <!-- Universal Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modal-title" class="text-xl font-bold"></h3>
                <button id="modal-close" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto modal-content"></div>
        </div>
    </div>
    
<script>
// --- START OF THE FINAL, FULLY-FUNCTIONAL SCRIPT ---
const API = "http://127.0.0.1:8000";
let token = null;
let currentUser = null;

// UTILITY FUNCTIONS
const el = (id) => document.getElementById(id);
const show = (element) => element.classList.remove('hidden');
const hide = (element) => element.classList.add('hidden');
const formatDate = (dateString) => new Date(dateString).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
const formatSimpleDate = (dateString) => new Date(dateString).toISOString().split('T')[0];

// API CALLER
async function apiCall(endpoint, method = 'GET', body = null, isFormData = false) {
    const headers = { 'Authorization': `Bearer ${token}` };
    const options = { method, headers };
    if (body) {
        if (isFormData) {
            options.body = body;
        } else {
            headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }
    }
    const response = await fetch(`${API}${endpoint}`, options);
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({ detail: `HTTP error! status: ${response.status}` }));
        throw new Error(errorData.detail);
    }
    const contentType = response.headers.get("content-type");
    if (contentType && contentType.includes("application/json")) {
        return response.json();
    }
    return true;
}

// LOGIN/LOGOUT
el('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const role = el('role').value;
    const email = el('email').value;
    const password = el('password').value;
    const errorEl = el('loginError');
    errorEl.textContent = '';
    try {
        const formData = new URLSearchParams({ username: email, password: password });
        const response = await fetch(`${API}/login/${role}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: formData,
        });
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || 'Login failed');
        }
        const data = await response.json();
        token = data.access_token;
        await initializeUserDashboard();
    } catch (error) {
        errorEl.textContent = error.message;
    }
});

el('logoutBtn').addEventListener('click', () => {
    token = null;
    currentUser = null;
    hide(el('appContainer'));
    show(el('loginPage'));
});

async function initializeUserDashboard() {
    try {
        currentUser = await apiCall('/me');
        el('userName').textContent = currentUser.name;
        el('userRole').textContent = currentUser.role;
        hide(el('loginPage'));
        show(el('appContainer'));
        if (currentUser.role === 'student') {
            show(el('studentView'));
            hide(el('teacherView'));
            setupStudentTabs();
        } else {
            show(el('teacherView'));
            hide(el('studentView'));
            setupTeacherTabs();
        }
    } catch (error) {
        console.error("Failed to initialize dashboard:", error);
        el('logoutBtn').click();
    }
}

// TAB MANAGEMENT
function setupTabs(tabsContainerId, panesContainerId, tabsConfig) {
    const tabsContainer = el(tabsContainerId);
    const panesContainer = el(panesContainerId);
    tabsContainer.innerHTML = '';
    panesContainer.innerHTML = '';
    tabsConfig.forEach((tab, index) => {
        const button = document.createElement('button');
        button.dataset.tab = tab.id;
        button.className = `py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-emerald-500 hover:border-emerald-500 ${index === 0 ? 'tab-active' : ''}`;
        button.textContent = tab.name;
        tabsContainer.appendChild(button);
        const pane = document.createElement('div');
        pane.id = `pane-${tab.id}`;
        pane.className = `${index > 0 ? 'hidden' : ''}`;
        panesContainer.appendChild(pane);
    });
    tabsContainer.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const tabId = e.target.dataset.tab;
            tabsContainer.querySelectorAll('button').forEach(btn => btn.classList.toggle('tab-active', btn.dataset.tab === tabId));
            panesContainer.querySelectorAll('div[id^="pane-"]').forEach(pane => pane.classList.toggle('hidden', pane.id !== `pane-${tabId}`));
            const tabConfig = tabsConfig.find(t => t.id === tabId);
            if (tabConfig && tabConfig.loadContent) tabConfig.loadContent();
        }
    });
    if (tabsConfig.length > 0 && tabsConfig[0].loadContent) {
        tabsConfig[0].loadContent();
    }
}

// STUDENT TABS
function setupStudentTabs() {
    setupTabs('studentTabs', 'studentPanes', [
        { id: 'home', name: 'Home', loadContent: loadStudentHome },
        { id: 'games', name: 'Soft Skill Games', loadContent: loadGamesForStudent },
        { id: 'leaderboard', name: 'Leaderboard', loadContent: loadFullLeaderboard },
        { id: 'analysis', name: 'Analysis', loadContent: loadStudentAnalysis },
        { id: 'profile', name: 'Profile', loadContent: loadStudentProfile }
    ]);
}

// TEACHER TABS
function setupTeacherTabs() {
    setupTabs('teacherTabs', 'teacherPanes', [
        { id: 'lessons', name: 'Manage Lessons & Quizzes', loadContent: loadTeacherLessons },
        { id: 'tasks', name: 'Manage Tasks', loadContent: loadTeacherTasks },
        { id: 'games', name: 'Manage Games', loadContent: loadTeacherGames },
        { id: 'review', name: 'Review Submissions', loadContent: loadTeacherReview },
        { id: 'reports', name: 'Student Reports', loadContent: loadTeacherReports },
        { id: 'notice', name: 'Notice Board', loadContent: loadTeacherNotice }
    ]);
}

// --- CONTENT LOADERS (STUDENT) ---
async function loadStudentHome() {
    const pane = el('pane-home');
    pane.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2 space-y-6"><div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Available Lessons</h2><div id="lessonsList"></div></div><div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Assigned Tasks</h2><div id="studentTasksList"></div></div></div><div class="space-y-6"><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-xl font-bold mb-4">Top Students</h3><div id="leaderboardSnapshot"></div></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-xl font-bold mb-4">Notice Board</h3><div id="studentNoticeBoard"></div></div><div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-xl font-bold mb-4">Task Reminders</h3><div id="taskReminders"></div></div></div></div>`;
    loadStudentLessons();
    loadStudentTasks();
    loadLeaderboardSnapshot();
    loadStudentNotice();
}
async function loadStudentLessons() {
    try {
        const lessons = await apiCall('/lessons');
        el('lessonsList').innerHTML = lessons.length ? lessons.map(l => `<div class="border rounded-lg p-4 bg-gray-50 flex flex-col justify-between mt-2"><div><h4 class="font-semibold">${l.title}</h4><p class="text-sm text-gray-500">${l.description}</p></div><button onclick="openLessonModal(${l.id})" class="mt-4 text-sm bg-emerald-100 text-emerald-700 font-semibold py-1 px-3 rounded-full hover:bg-emerald-200 self-start">View & Take Quiz</button></div>`).join('') : '<p>No lessons available.</p>';
    } catch (e) { el('lessonsList').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; }
}
async function loadStudentTasks() {
    try {
        const tasks = await apiCall('/tasks');
        const listEl = el('studentTasksList');
        const remindersEl = el('taskReminders');
        listEl.innerHTML = tasks.length ? tasks.map(t => `<div class="border p-4 rounded-lg mt-2"> <h4 class="font-semibold">${t.title}</h4> <p class="text-sm">${t.description}</p> <p class="text-sm font-medium mt-2">Max Points: ${t.points} | Deadline: ${formatDate(t.deadline)}</p> ${t.submission_status ? `<div class="mt-2 text-sm font-semibold ${t.submission_status.approved ? 'text-green-600' : 'text-blue-600'}">${t.submission_status.approved ? `Graded: ${t.submission_status.points_awarded} Points` : 'Pending Review'}</div>` : `<form class="task-submission-form mt-4" data-task-id="${t.id}"> <input type="file" required class="text-sm"> <button type="submit" class="text-sm bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600">Submit</button> </form>`} </div>`).join('') : '<p>No tasks assigned yet.</p>';
        remindersEl.innerHTML = tasks.filter(t => !t.submission_status).map(t => `<p class="text-sm text-gray-600">${t.title} - Due ${formatDate(t.deadline)}</p>`).join('') || '<p class="text-sm text-gray-500">No pending tasks.</p>';
        document.querySelectorAll('.task-submission-form').forEach(form => form.addEventListener('submit', handleTaskSubmit));
    } catch (e) { el('studentTasksList').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; el('taskReminders').innerHTML = ''; }
}
async function loadLeaderboardSnapshot() {
    try {
        const leaderboard = await apiCall('/leaderboard');
        el('leaderboardSnapshot').innerHTML = leaderboard.slice(0, 3).map((u, i) => `<div class="flex items-center space-x-3"><span class="font-bold text-lg">${i + 1}.</span><div><p class="font-semibold">${u.name}</p><p class="text-sm text-gray-500">${u.points} points</p></div></div>`).join('') || '<p>Leaderboard is empty.</p>';
    } catch(e) { el('leaderboardSnapshot').innerHTML = `<p class="text-red-500">Error.</p>`}
}
async function loadStudentNotice() {
    try {
        const notice = await apiCall('/notice');
        el('studentNoticeBoard').innerHTML = `<p class="font-semibold">${notice.message}</p><p class="text-xs mt-2 text-yellow-600">Posted on: ${formatDate(notice.created_at)}</p>`;
    } catch(e) { el('studentNoticeBoard').innerHTML = `<p class="text-red-500">Error loading notice.</p>`}
}
async function loadGamesForStudent() {
     const pane = el('pane-games');
     pane.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Soft Skill Games</h2><p class="text-gray-600 mb-6">Play these games to improve your skills. After playing, come back here and report your score!</p><div id="studentGamesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>`;
    try {
        const games = await apiCall('/games');
        el('studentGamesList').innerHTML = games.map(g => `<div class="border rounded-lg p-4 flex flex-col"><h3 class="font-bold">${g.name}</h3><p class="text-sm text-gray-500 mb-2">${g.skill}</p><a href="${g.url}" target="_blank" class="text-sm text-blue-500 hover:underline mb-4">Play Game &rarr;</a><form class="game-score-form mt-auto" data-game-id="${g.id}"><input type="number" placeholder="Enter score" required class="w-full border rounded px-2 py-1 text-sm"><button type="submit" class="mt-2 w-full text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-full hover:bg-gray-300">Report Score</button></form></div>`).join('') || '<p>No games available.</p>';
        document.querySelectorAll('.game-score-form').forEach(form => form.addEventListener('submit', handleGameScoreSubmit));
    } catch(e) { el('studentGamesList').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; }
}
async function loadFullLeaderboard() {
     const pane = el('pane-leaderboard');
     pane.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Overall Leaderboard</h2><div id="fullLeaderboardList" class="space-y-2"></div></div>`;
     try {
        const leaderboard = await apiCall('/leaderboard');
        el('fullLeaderboardList').innerHTML = leaderboard.map((u, i) => {
            let medal = '';
            if (i === 0) medal = 'ðŸ¥‡';
            if (i === 1) medal = 'ðŸ¥ˆ';
            if (i === 2) medal = 'ðŸ¥‰';
            return `<div class="flex items-center justify-between p-3 rounded-lg ${i === 0 ? 'bg-yellow-100 border border-yellow-300' : i === 1 ? 'bg-gray-200' : i === 2 ? 'bg-orange-100 border border-orange-300' : 'bg-gray-50'}"><div class="flex items-center space-x-4"><span class="font-bold text-lg w-8 text-center">${medal || i + 1}</span><p class="font-semibold">${u.name}</p></div><p class="font-bold text-emerald-600">${u.points} PTS</p></div>`
        }).join('');
    } catch(e) { el('fullLeaderboardList').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; }
}
async function loadStudentAnalysis() {
    const pane = el('pane-analysis');
    pane.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Your Performance Analysis</h2><div id="analysisContent">Loading...</div></div>`;
    try {
        const report = await apiCall(`/reports/student/${currentUser.id}`);
        el('analysisContent').innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-center">
                <div class="lg:col-span-1 bg-gray-50 p-6 rounded-lg shadow-inner text-center">
                    <h3 class="text-lg font-semibold mb-2">Total Academic Score</h3>
                    <p class="text-6xl font-bold text-emerald-500">${report.academic_score}</p>
                    <p class="text-sm text-gray-500 mt-1">From Quizzes & Tasks</p>
                    <div class="mt-4 mx-auto" style="position: relative; height:200px; width:200px;"><canvas id="academicScoreChart"></canvas></div>
                </div>
                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold mb-2">Soft Skill Levels (Avg. Score)</h3>
                    ${Object.keys(report.soft_skills).length ? '<div class="mt-4 mx-auto" style="position: relative; height:300px; max-width:400px;"><canvas id="softSkillsChart"></canvas></div>' : '<p>Play some Soft Skill Games to see your analysis!</p>'}
                </div>
            </div>`;

        const taskPoints = report.academic_score - (report.user.points - report.academic_score);
        const quizPoints = report.academic_score - taskPoints;
        
        if (report.academic_score > 0) {
            new Chart(el('academicScoreChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Quizzes', 'Tasks'],
                    datasets: [{ data: [quizPoints, taskPoints], backgroundColor: ['#34D399', '#3B82F6'], borderColor: '#F9FAFB', borderWidth: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        if (Object.keys(report.soft_skills).length) {
            new Chart(el('softSkillsChart'), {
                type: 'radar',
                data: {
                    labels: Object.keys(report.soft_skills),
                    datasets: [{ label: 'Average Score', data: Object.values(report.soft_skills), fill: true, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgb(59, 130, 246)', pointBackgroundColor: 'rgb(59, 130, 246)' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, max: 100, ticks: { backdropColor: 'transparent'} } } }
            });
        }
    } catch (e) { el('analysisContent').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; }
}
async function loadStudentProfile() {
    const pane = el('pane-profile');
    pane.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm" id="profileContent">Loading...</div>`;
    try {
        const profile = await apiCall('/profile');
        el('profileContent').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 flex flex-col items-center text-center bg-gray-50 p-6 rounded-lg">
                    <div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                        <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold">${profile.name}</h2>
                    <p class="text-gray-500">${currentUser.email}</p>
                    <div class="mt-6">
                        <p class="text-4xl font-bold text-emerald-500">${currentUser.points}</p>
                        <p class="text-sm text-gray-500">Total Points</p>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <h2 class="text-2xl font-bold mb-4">Your Profile Details</h2>
                    <form id="profileForm" class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="profileName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" value="${profile.name || ''}"></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Register Number</label><input type="text" id="profileRegNum" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" value="${profile.register_number || ''}"></div>
                            <div><label class="block text-sm font-medium text-gray-700">Date of Birth</label><input type="date" id="profileDob" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" value="${profile.date_of_birth || ''}"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Gender</label><select id="profileGender" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"><option>Male</option><option>Female</option><option>Other</option></select></div>
                            <div><label class="block text-sm font-medium text-gray-700">Age</label><input type="text" id="profileAge" class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-md shadow-sm py-2 px-3" readonly value="${profile.age || ''}"></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700">Address</label><textarea id="profileAddress" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">${profile.address || ''}</textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700">Residence</label><select id="profileResidence" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"><option>Day Scholar</option><option>Hosteller</option></select></div>
                        <button type="submit" class="bg-emerald-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-emerald-600">Save Changes</button>
                    </form>
                </div>
            </div>`;
        if(profile.gender) el('profileGender').value = profile.gender;
        if(profile.residence) el('profileResidence').value = profile.residence;
        el('profileDob').addEventListener('change', calculateAge);
        el('profileForm').addEventListener('submit', handleProfileUpdate);
        calculateAge();
    } catch(e) { el('profileContent').innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; }
}
function calculateAge() {
    const dob = el('profileDob').value;
    if (dob) {
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
        el('profileAge').value = age;
    }
}

// --- STUDENT FORM HANDLERS ---
async function handleProfileUpdate(e){e.preventDefault();const data={name:el('profileName').value,register_number:el('profileRegNum').value,date_of_birth:el('profileDob').value,gender:el('profileGender').value,address:el('profileAddress').value,residence:el('profileResidence').value};try{await apiCall('/profile','PUT',data);alert('Profile updated!');currentUser.name=data.name;el('userName').textContent=currentUser.name}catch(e){alert(`Error: ${e.message}`)}}
async function handleTaskSubmit(e){e.preventDefault();const taskId=e.target.dataset.taskId;const fileInput=e.target.querySelector('input[type="file"]');if(!fileInput.files.length)return alert('Please select a file.');const formData=new FormData();formData.append('file',fileInput.files[0]);try{await apiCall(`/tasks/${taskId}/submit`,'POST',formData,true);alert('Task submitted!');loadStudentTasks()}catch(e){alert(`Error: ${e.message}`)}}
async function handleGameScoreSubmit(e){e.preventDefault();const gameId=e.target.dataset.gameId;const score=e.target.querySelector('input').value;if(!score)return alert('Please enter a score.');try{await apiCall('/games/submit-score','POST',{game_id:parseInt(gameId),score:parseInt(score)});alert('Score submitted!');e.target.querySelector('input').value=''}catch(e){alert(`Error: ${e.message}`)}}
async function handleQuizSubmit(event,quizId){event.preventDefault();const answers=Array.from(event.target.elements).filter(el=>el.tagName==='TEXTAREA').map(el=>({question_id:parseInt(el.name.split('_')[1]),answer_text:el.value}));try{await apiCall(`/quizzes/${quizId}/submit`,'POST',{answers});alert('Quiz submitted!');hide(el('modal'));loadStudentHome()}catch(error){alert(`Error: ${error.message}`)}}

// --- MODAL & QUIZ ---
el('modal-close').addEventListener('click', () => hide(el('modal')));
async function openLessonModal(lessonId){el('modal-title').textContent='Loading...';el('modal-body').innerHTML='<p>Loading...</p>';show(el('modal'));try{const data=await apiCall(`/lessons/${lessonId}/quiz`);el('modal-title').textContent=data.lesson.title;let bodyHtml=`<div class="aspect-w-16 aspect-h-9 mb-4"><iframe src="${data.lesson.video_url}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="w-full h-96 rounded-lg"></iframe></div> <p class="text-gray-600 mb-6">${data.lesson.description}</p>`;if(data.quiz){if(data.submission){bodyHtml+=`<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md"><h4 class="font-bold">Quiz Submitted</h4><p>Status: ${data.submission.is_graded?`Graded (Score: ${data.submission.score})`:'Pending Review'}</p></div>`}else{bodyHtml+=`<h3 class="text-xl font-bold mt-6 mb-4">Quiz: ${data.quiz.total_points} Total Points</h3><form id="quizForm">${data.quiz.questions.map((q,i)=>`<div class="mb-4"><label class="block font-medium text-gray-700">${i+1}. ${q.question_text}</label><textarea name="answer_${q.id}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" rows="3"></textarea></div>`).join('')}<button type="submit" class="w-full bg-emerald-500 text-white py-2 rounded-lg font-semibold hover:bg-emerald-600">Submit Quiz</button></form>`}}else{bodyHtml+='<p class="text-gray-500">No quiz for this lesson.</p>'}
el('modal-body').innerHTML=bodyHtml;if(data.quiz&&!data.submission){el('quizForm').addEventListener('submit',(e)=>handleQuizSubmit(e,data.quiz.id))}}catch(error){el('modal-body').innerHTML=`<p class="text-red-500">Error: ${error.message}</p>`}}

// --- TEACHER CONTENT LOADERS (FULLY IMPLEMENTED) ---
async function loadTeacherLessons(){const pane=el('pane-lessons');pane.innerHTML=`<div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Manage Lessons & Quizzes</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div id="lesson-list-container"><h3>Existing Lessons</h3><div id="teacher-lesson-list" class="mt-2 space-y-2"></div></div><div><h3>Add New Lesson</h3><form id="add-lesson-form" class="space-y-3"><input type="text" name="title" placeholder="Lesson Title" required class="w-full border rounded p-2"><textarea name="description" placeholder="Description" required class="w-full border rounded p-2" rows="3"></textarea><input type="text" name="video_url" placeholder="YouTube Embed URL" required class="w-full border rounded p-2"><button type="submit" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">Add Lesson</button></form></div></div></div>`;el('add-lesson-form').addEventListener('submit',handleAddLesson);try{const lessons=await apiCall('/lessons');el('teacher-lesson-list').innerHTML=lessons.map(l=>`<div class="p-3 border rounded-md flex justify-between items-center"><span>${l.title}</span><button onclick="openQuizEditor(${l.id})" class="text-xs bg-gray-200 px-2 py-1 rounded-full hover:bg-gray-300">Manage Quiz</button></div>`).join('')||'<p>No lessons created yet.</p>'}catch(e){el('teacher-lesson-list').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}}
async function loadTeacherTasks(){const pane=el('pane-tasks');pane.innerHTML=`<div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Manage Tasks</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div id="task-list-container"><h3>Assigned Tasks</h3><div id="teacher-task-list" class="mt-2 space-y-2"></div></div><div><h3>Assign New Task</h3><form id="add-task-form" class="space-y-3"><input type="text" name="title" placeholder="Task Title" required class="w-full border rounded p-2"><textarea name="description" placeholder="Description" required class="w-full border rounded p-2" rows="3"></textarea><input type="number" name="points" placeholder="Max Points" required class="w-full border rounded p-2"><input type="date" name="deadline" required class="w-full border rounded p-2"><button type="submit" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">Assign Task</button></form></div></div></div>`;el('add-task-form').addEventListener('submit',handleAddTask);try{const tasks=await apiCall('/tasks/all');el('teacher-task-list').innerHTML=tasks.map(t=>`<div class="p-3 border rounded-md"> <p class="font-semibold">${t.title}</p> <p class="text-sm text-gray-500">Due: ${formatDate(t.deadline)}</p> </div>`).join('')||'<p>No tasks assigned yet.</p>'}catch(e){el('teacher-task-list').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}}
async function loadTeacherGames(){const pane=el('pane-games');pane.innerHTML=`<div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Manage Games</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div id="game-list-container"><h3>Available Games</h3><div id="teacher-game-list" class="mt-2 space-y-2"></div></div><div><h3>Add New Game</h3><form id="add-game-form" class="space-y-3"><input type="text" name="name" placeholder="Game Name" required class="w-full border rounded p-2"><input type="url" name="url" placeholder="Game URL" required class="w-full border rounded p-2"><input type="text" name="skill" placeholder="Associated Skill" required class="w-full border rounded p-2"><button type="submit" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">Add Game</button></form></div></div></div>`;el('add-game-form').addEventListener('submit',handleAddGame);try{const games=await apiCall('/games');el('teacher-game-list').innerHTML=games.map(g=>`<div class="p-3 border rounded-md flex justify-between items-center"><div><p class="font-semibold">${g.name}</p><p class="text-xs text-gray-500">${g.skill}</p></div><button onclick="handleDeleteGame(${g.id})" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full hover:bg-red-200">Delete</button></div>`).join('')||'<p>No games added yet.</p>'}catch(e){el('teacher-game-list').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}}
async function loadTeacherReview(){const pane=el('pane-review');pane.innerHTML=`<div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Review Submissions</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h3 class="text-lg font-semibold">Pending Task Submissions</h3><div id="task-review-list" class="mt-2 space-y-2"></div></div><div><h3 class="text-lg font-semibold">Pending Quiz Submissions</h3><div id="quiz-review-list" class="mt-2 space-y-2"></div></div></div></div>`;try{const tasks=await apiCall('/submissions/tasks');el('task-review-list').innerHTML=tasks.map(t=>`<div class="p-3 border rounded-md"> <p class="font-semibold">${t.task_title}</p><p class="text-sm text-gray-600">By: ${t.student_name}</p><button onclick="openTaskReviewModal(${t.id})" class="mt-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full hover:bg-blue-200">Review</button></div>`).join('')||'<p>No task submissions to review.</p>'}catch(e){el('task-review-list').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}
try{const quizzes=await apiCall('/submissions/quizzes');el('quiz-review-list').innerHTML=quizzes.map(q=>`<div class="p-3 border rounded-md"><p class="font-semibold">${q.quiz_title}</p><p class="text-sm text-gray-600">By: ${q.student_name}</p><button onclick="openQuizReviewModal(${q.id})" class="mt-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full hover:bg-blue-200">Review</button></div>`).join('')||'<p>No quiz submissions to review.</p>'}catch(e){el('quiz-review-list').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}}
async function loadTeacherReports(){const pane=el('pane-reports');pane.innerHTML=`<div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Student Reports</h2><div id="student-report-list" class="mt-2 space-y-2"></div></div>`;try{const students=await apiCall('/reports/students');el('student-report-list').innerHTML=students.map(s=>`<div class="p-3 border rounded-md flex justify-between items-center"><div><p class="font-semibold">${s.name}</p><p class="text-sm text-gray-500">${s.email}</p></div><button onclick="openStudentReportModal(${s.id})" class="text-xs bg-gray-200 px-2 py-1 rounded-full hover:bg-gray-300">View Report</button></div>`).join('')||'<p>No students found.</p>'}catch(e){el('student-report-list').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}}
async function loadTeacherNotice(){const pane=el('pane-notice');pane.innerHTML=`<div class="bg-white p-6 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4">Manage Notice Board</h2><div><h3>Post New Notice</h3><form id="add-notice-form" class="space-y-3"><textarea name="message" placeholder="Enter your notice here..." required class="w-full border rounded p-2" rows="4"></textarea><button type="submit" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">Post Notice</button></form></div><div class="mt-6"><h3>Current Notice</h3><div id="current-notice" class="p-4 bg-gray-100 rounded-md"></div></div></div>`;el('add-notice-form').addEventListener('submit',handlePostNotice);try{const notice=await apiCall('/notice');el('current-notice').textContent=notice.message}catch(e){el('current-notice').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}}
async function handleAddLesson(e){e.preventDefault();const data={title:e.target.title.value,description:e.target.description.value,video_url:e.target.video_url.value};try{await apiCall('/lessons','POST',data);alert('Lesson added!');e.target.reset();loadTeacherLessons()}catch(e){alert(`Error: ${e.message}`)}}
async function handleAddTask(e){e.preventDefault();const data={title:e.target.title.value,description:e.target.description.value,points:parseInt(e.target.points.value),deadline:e.target.deadline.value};try{await apiCall('/tasks/assign','POST',data);alert('Task assigned!');e.target.reset();loadTeacherTasks()}catch(e){alert(`Error: ${e.message}`)}}
async function handleAddGame(e){e.preventDefault();const formData=new FormData(e.target);try{await apiCall('/games','POST',formData,true);alert('Game added!');e.target.reset();loadTeacherGames()}catch(e){alert(`Error: ${e.message}`)}}
async function handlePostNotice(e){e.preventDefault();const formData=new FormData(e.target);try{await apiCall('/notice','POST',formData,true);alert('Notice posted!');e.target.reset();loadTeacherNotice()}catch(e){alert(`Error: ${e.message}`)}}
async function handleDeleteGame(gameId){if(!confirm('Are you sure you want to delete this game?'))return;try{await apiCall(`/games/${gameId}`,'DELETE');alert('Game deleted!');loadTeacherGames()}catch(e){alert(`Error: ${e.message}`)}}
async function openQuizEditor(lessonId){el('modal-title').textContent='Manage Quiz';el('modal-body').innerHTML='<div id="quiz-editor-questions" class="space-y-2"></div><button id="add-question-btn" class="text-sm mt-4 bg-gray-200 px-3 py-1 rounded-md">Add Question</button><hr class="my-4"><button id="save-quiz-btn" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">Save Quiz</button>';show(el('modal'));const container=el('quiz-editor-questions');const addQuestionInput=(text='')=>{const div=document.createElement('div');div.className='flex items-center space-x-2';div.innerHTML=`<input type="text" value="${text}" class="w-full border rounded p-2 question-input" placeholder="Enter question text..."><button class="text-red-500 font-bold text-xl remove-question-btn">&times;</button>`;container.appendChild(div);div.querySelector('.remove-question-btn').onclick=()=>div.remove()};el('add-question-btn').onclick=()=>addQuestionInput();el('save-quiz-btn').onclick=async()=>{const questions=Array.from(document.querySelectorAll('.question-input')).map(input=>({question_text:input.value})).filter(q=>q.question_text);if(!questions.length)return alert('Add at least one question.');try{await apiCall(`/lessons/${lessonId}/quizzes`,'POST',{questions});alert('Quiz saved!');hide(el('modal'))}catch(e){alert(`Error: ${e.message}`)}};const data=await apiCall(`/lessons/${lessonId}/quiz`);if(data.quiz&&data.quiz.questions.length){data.quiz.questions.forEach(q=>addQuestionInput(q.question_text))}else{addQuestionInput()}}
async function openTaskReviewModal(submissionId){el('modal-title').textContent='Review Task Submission';show(el('modal'));try{const subs=await apiCall('/submissions/tasks');const sub=subs.find(s=>s.id===submissionId);el('modal-body').innerHTML=`<p><strong>Student:</strong> ${sub.student_name}</p><p><strong>Task:</strong> ${sub.task_title}</p><p><strong>Submitted File:</strong> <a href="${API}/media/${sub.filename}" target="_blank" class="text-blue-500 hover:underline">View File</a></p><form id="grade-task-form" class="mt-4"><label>Award Points (Max: ${sub.max_points})</label><input type="number" id="grade-points" max="${sub.max_points}" min="0" required class="w-full border rounded p-2 mt-1"><button type="submit" class="bg-emerald-500 text-white px-4 py-2 rounded-lg mt-2">Approve & Grade</button></form>`;el('grade-task-form').addEventListener('submit',async(e)=>{e.preventDefault();const points=el('grade-points').value;try{await apiCall(`/submissions/tasks/${submissionId}/grade`,'POST',{points:parseInt(points)});alert('Task graded!');hide(el('modal'));loadTeacherReview()}catch(err){alert(`Error: ${err.message}`)}})}catch(e){el('modal-body').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}}
async function openQuizReviewModal(submissionId){el('modal-title').textContent='Review Quiz Submission';show(el('modal'));try{const sub=await apiCall(`/submissions/quizzes/${submissionId}`);el('modal-body').innerHTML=`<p><strong>Student:</strong> ${sub.student_name}</p><p><strong>Quiz for:</strong> ${sub.quiz_title}</p><div class="mt-4 space-y-4">${sub.answers.map(a=>`<div class="p-2 bg-gray-100 rounded-md"><strong>Q:</strong> ${a.question_text}<br><strong>A:</strong> ${a.answer_text}</div>`).join('')}</div><form id="grade-quiz-form" class="mt-4"><label>Award Score (Total Points: ${sub.total_points})</label><input type="number" id="grade-score" max="${sub.total_points}" min="0" required class="w-full border rounded p-2 mt-1"><button type="submit" class="bg-emerald-500 text-white px-4 py-2 rounded-lg mt-2">Submit Grade</button></form>`;el('grade-quiz-form').addEventListener('submit',async(e)=>{e.preventDefault();const score=el('grade-score').value;try{await apiCall(`/submissions/quizzes/${submissionId}/grade`,'POST',{score:parseInt(score)});alert('Quiz graded!');hide(el('modal'));loadTeacherReview()}catch(err){alert(`Error: ${err.message}`)}})}catch(e){el('modal-body').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}}
async function openStudentReportModal(studentId){el('modal-title').textContent='Student Performance Report';show(el('modal'));el('modal-body').innerHTML='Loading report...';try{const report=await apiCall(`/reports/student/${studentId}`);el('modal-body').innerHTML=`<h3 class="font-bold text-lg">${report.user.name}</h3> <p class="text-sm text-gray-500">${report.user.email}</p> <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"> <div class="bg-gray-50 p-4 rounded-lg"><h4 class="font-semibold">Academic Score</h4><p class="text-3xl font-bold text-emerald-500">${report.academic_score}</p></div> <div class="bg-gray-50 p-4 rounded-lg"><h4 class="font-semibold">Soft Skills</h4><div class="space-y-2 mt-2">${Object.keys(report.soft_skills).length?Object.entries(report.soft_skills).map(([skill,score])=>`<p class="text-sm"><strong>${skill}:</strong> ${score.toFixed(1)} avg.</p>`).join(''):'<p>No scores.</p>'}</div></div> </div>`}catch(e){el('modal-body').innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`}}
</script>

</body>
</html>

